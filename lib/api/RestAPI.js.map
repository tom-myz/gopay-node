{"version":3,"sources":["RestAPI.js"],"names":["require","process","decamelize","constants_1","object_1","fetch_1","TimeoutError_1","parser_1","RestAPI","options","endpoint","DEFAULT_ENDPOINT","appId","env","ENV_KEY_APP_ID","secret","ENV_KEY_SECRET","requestParams","params","transformKeys","requestUrl","url","data","isQueryString","queryString","Object","keys","map","k","encodeURIComponent","join","handleSuccess","response","resolve","callback","handleError","error","reject","err","fromError","getData","partitionKeys","indexOf","getBody","payload","_","_data","JSON","stringify","getHeaders","body","headers","Headers","append","send","method","constructor","Promise","request","Request","mode","fetch","then","checkStatus","parseJSON","catch","longPolling","promise","condition","interval","POLLING_INTERVAL","poll","timeout","POLLING_TIMEOUT","elapsedTime","pollWait","wait","setTimeout","polling","generator","TimeoutError","next","value","exports"],"mappings":"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","file":"RestAPI.js","sourcesContent":["\"use strict\";\nrequire(\"isomorphic-fetch\");\nconst process = require(\"process\");\nconst decamelize = require(\"decamelize\");\nconst constants_1 = require(\"../constants\");\nconst object_1 = require(\"../utils/object\");\nconst fetch_1 = require(\"../utils/fetch\");\nconst TimeoutError_1 = require(\"../errors/TimeoutError\");\nconst parser_1 = require(\"../errors/parser\");\nclass RestAPI {\n    constructor(options = {}) {\n        this.endpoint = options.endpoint || constants_1.DEFAULT_ENDPOINT;\n        this.appId = options.appId || process.env[constants_1.ENV_KEY_APP_ID];\n        this.secret = options.secret || process.env[constants_1.ENV_KEY_SECRET];\n    }\n    static requestParams(params) {\n        return object_1.transformKeys(params, decamelize);\n    }\n    static requestUrl(url, data, isQueryString) {\n        let queryString;\n        if (isQueryString) {\n            queryString = Object.keys(data || {})\n                .map((k) => `${encodeURIComponent(k)}=${encodeURIComponent(data[k])}`)\n                .join(\"&\");\n        }\n        return queryString ? `${url}?${queryString}` : url;\n    }\n    static handleSuccess(response, resolve, callback) {\n        if (typeof callback === \"function\") {\n            callback(response);\n        }\n        resolve(response);\n    }\n    static handleError(error, reject, callback) {\n        const err = parser_1.fromError(error);\n        if (typeof callback === \"function\") {\n            callback(err);\n        }\n        reject(err);\n    }\n    static getData(data) {\n        return object_1.partitionKeys(data, (k) => [\"appId\", \"secret\"].indexOf(k) !== -1);\n    }\n    getBody(data, payload) {\n        const [_, _data] = RestAPI.getData(data);\n        return !payload ? JSON.stringify(RestAPI.requestParams(_data)) : null;\n    }\n    getHeaders(data, body) {\n        const [{ appId, secret }, _] = RestAPI.getData(data);\n        const headers = new Headers();\n        headers.append(\"Accept\", \"application/json\");\n        headers.append(\"Content-Type\", \"application/json\");\n        if (appId || this.appId) {\n            headers.append(\"Authorization\", `ApplicationToken ${appId || this.appId}|${secret || this.secret || \"\"}`);\n        }\n        return headers;\n    }\n    send(method, url, data, callback) {\n        const payload = [\"GET\", \"DELETE\"].indexOf(method) !== -1;\n        const body = this.getBody(data, payload);\n        const headers = this.getHeaders(data, body);\n        const [_, _data] = (this.constructor.getData || RestAPI.getData)(data);\n        return new Promise((resolve, reject) => {\n            const request = new Request(`${this.endpoint}${RestAPI.requestUrl(url, RestAPI.requestParams(_data), payload)}`, {\n                body,\n                headers,\n                method,\n                mode: \"cors\"\n            });\n            fetch(request)\n                .then(fetch_1.checkStatus)\n                .then(fetch_1.parseJSON)\n                .then((response) => RestAPI.handleSuccess(response, resolve, callback))\n                .catch((error) => RestAPI.handleError(error, reject, callback));\n        });\n    }\n    longPolling(promise, condition, callback, interval = constants_1.POLLING_INTERVAL, timeout = constants_1.POLLING_TIMEOUT) {\n        let elapsedTime = 0;\n        function pollWait(wait) {\n            return new Promise((resolve) => setTimeout(() => {\n                elapsedTime += wait;\n                resolve();\n            }, wait));\n        }\n        function* poll() {\n            while (true) {\n                yield promise();\n            }\n        }\n        function polling(generator = poll()) {\n            if (elapsedTime >= timeout) {\n                return Promise.reject(new TimeoutError_1.TimeoutError(timeout));\n            }\n            return pollWait(interval)\n                .then(() => generator.next().value)\n                .then((response) => {\n                if (!condition(response)) {\n                    return polling(generator);\n                }\n                return response;\n            });\n        }\n        return new Promise((resolve, reject) => {\n            polling()\n                .then((response) => RestAPI.handleSuccess(response, resolve, callback))\n                .catch((error) => RestAPI.handleError(error, reject, callback));\n        });\n    }\n}\nexports.RestAPI = RestAPI;\n"]}